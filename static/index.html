<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PGR Sports Analytics</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--card:#1a1d29;--card2:#222639;--accent:#FF6B35;--green:#38ef7d;--red:#ff4757;--yellow:#ffa502;--blue:#70a1ff;--text:#e4e6eb;--text2:#9ca3af;--border:#2d3148}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:1rem}
header{text-align:center;padding:1.5rem 0 1rem}
header h1{font-size:1.8rem;font-weight:700;color:var(--accent)}
header p{color:var(--text2);font-size:.9rem;margin-top:.3rem}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border-radius:10px;padding:1rem;text-align:center;border:1px solid var(--border)}
.stat-card .value{font-size:1.6rem;font-weight:700}
.stat-card .label{font-size:.75rem;color:var(--text2);margin-top:.2rem;text-transform:uppercase;letter-spacing:.5px}
.stat-card.green .value{color:var(--green)}
.stat-card.red .value{color:var(--red)}
.stat-card.accent .value{color:var(--accent)}
.filters{background:var(--card);border-radius:10px;padding:1rem;margin-bottom:1rem;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;border:1px solid var(--border)}
.filters select,.filters input{background:var(--card2);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:.5rem .75rem;font-size:.85rem;outline:none}
.filters select:focus,.filters input:focus{border-color:var(--accent)}
.filters button{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:.5rem 1rem;font-size:.85rem;cursor:pointer;font-weight:600}
.filters button:hover{opacity:.9}
.filters button.secondary{background:var(--card2);border:1px solid var(--border)}
.nav-tabs{display:flex;gap:0;margin-bottom:1rem;border-bottom:2px solid var(--border);overflow-x:auto;flex-wrap:wrap}
.nav-tab{padding:.6rem 1.2rem;cursor:pointer;font-size:.85rem;font-weight:600;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;white-space:nowrap}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tabs{display:flex;gap:0;margin-bottom:1rem;border-bottom:2px solid var(--border)}
.tab{padding:.6rem 1.2rem;cursor:pointer;font-size:.85rem;font-weight:600;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.bets-list{display:flex;flex-direction:column;gap:.6rem}
.bet-card{background:var(--card);border-radius:10px;padding:1rem 1.1rem;border:1px solid var(--border);border-left:3px solid var(--border);display:grid;grid-template-columns:auto 1fr auto;gap:1rem;align-items:center;transition:all .25s ease;position:relative;overflow:hidden}
.bet-card::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;opacity:0;transition:opacity .25s;pointer-events:none;border-radius:10px}
.bet-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.bet-card.status-won{border-left-color:var(--green);background:linear-gradient(135deg,rgba(56,239,125,.04),var(--card) 60%)}
.bet-card.status-won::before{background:linear-gradient(90deg,rgba(56,239,125,.06),transparent 40%);opacity:1}
.bet-card.status-lost{border-left-color:var(--red);background:linear-gradient(135deg,rgba(255,71,87,.04),var(--card) 60%)}
.bet-card.status-lost::before{background:linear-gradient(90deg,rgba(255,71,87,.06),transparent 40%);opacity:1}
.bet-card.status-upcoming{border-left-color:var(--accent);background:var(--card)}
.bet-card.status-live{border-left-color:#60a5fa;background:linear-gradient(135deg,rgba(96,165,250,.06),var(--card) 60%);box-shadow:0 0 15px rgba(96,165,250,.08)}
.bet-card.status-live::before{background:linear-gradient(90deg,rgba(96,165,250,.08),transparent 40%);opacity:1}
.bet-card.status-void{border-left-color:var(--text2);opacity:.65}
.bet-sport{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.15rem;background:var(--card2);position:relative;z-index:1}
.bet-info{position:relative;z-index:1}
.bet-info h3{font-size:.9rem;font-weight:600;margin-bottom:.3rem;letter-spacing:.01em}
.bet-info .market{font-size:.8rem;font-weight:600}
.status-won .bet-info .market{color:var(--green)}
.status-lost .bet-info .market{color:var(--red)}
.status-upcoming .bet-info .market{color:var(--accent)}
.status-live .bet-info .market{color:#60a5fa}
.status-void .bet-info .market{color:var(--text2)}
.bet-info .meta{color:var(--text2);font-size:.75rem;margin-top:.25rem}
.bet-right{text-align:right;position:relative;z-index:1}
.bet-right .odds{font-size:1.15rem;font-weight:700;letter-spacing:.02em}
.bet-right .ev{font-size:.75rem;margin-top:.2rem}
.bet-right .ev.positive{color:var(--green)}
.status-badge{display:inline-block;padding:.2rem .6rem;border-radius:5px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-top:.2rem}
.status-badge.won{background:rgba(56,239,125,.15);color:var(--green);box-shadow:0 0 8px rgba(56,239,125,.1)}
.status-badge.lost{background:rgba(255,71,87,.15);color:var(--red);box-shadow:0 0 8px rgba(255,71,87,.1)}
.status-badge.upcoming{background:rgba(255,107,53,.12);color:var(--accent)}
.status-badge.live{background:rgba(96,165,250,.18);color:#60a5fa;box-shadow:0 0 10px rgba(96,165,250,.12);animation:livePulse 2s ease-in-out infinite}
.status-badge.void{background:rgba(156,163,175,.12);color:var(--text2)}
.status-badge.PRODUCTION{background:rgba(56,239,125,.15);color:var(--green)}
.status-badge.LEARNING_ONLY{background:rgba(255,165,2,.15);color:var(--yellow)}
.status-badge.DISABLED{background:rgba(255,71,87,.15);color:var(--red)}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.7}}
.profit{font-weight:700;font-size:.85rem;margin-top:.1rem}
.profit.win{color:var(--green)}
.profit.loss{color:var(--red)}
.pagination{display:flex;justify-content:center;align-items:center;gap:1rem;padding:1.5rem 0}
.pagination button{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:.5rem 1rem;cursor:pointer;font-size:.85rem}
.pagination button:disabled{opacity:.4;cursor:default}
.pagination span{color:var(--text2);font-size:.85rem}
.loading{text-align:center;padding:2rem;color:var(--text2)}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:3rem;color:var(--text2)}
.page-section{display:none}
.page-section.active{display:block}
table.data-table{width:100%;border-collapse:collapse;margin-top:.5rem}
table.data-table th,table.data-table td{padding:.6rem .8rem;text-align:left;border-bottom:1px solid var(--border);font-size:.82rem}
table.data-table th{color:var(--text2);font-weight:600;text-transform:uppercase;font-size:.7rem;letter-spacing:.5px;position:sticky;top:0;background:var(--bg)}
table.data-table td{color:var(--text)}
table.data-table tr:hover{background:var(--card2)}
.table-container{background:var(--card);border-radius:10px;border:1px solid var(--border);overflow:auto;max-height:600px}
.section-title{font-size:1.1rem;font-weight:700;margin-bottom:.75rem;color:var(--text)}
.section-subtitle{font-size:.85rem;color:var(--text2);margin-bottom:1rem}
.window-select{display:flex;gap:.5rem;margin-bottom:1rem}
.window-btn{padding:.4rem .8rem;border-radius:6px;border:1px solid var(--border);background:var(--card2);color:var(--text2);cursor:pointer;font-size:.8rem;font-weight:600}
.window-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.promo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:.75rem;margin-top:1rem}
.promo-card{background:var(--card);border-radius:8px;padding:1rem;border:1px solid var(--border)}
.promo-card h4{font-size:.85rem;margin-bottom:.4rem}
.promo-card .promo-meta{color:var(--text2);font-size:.75rem}
.promo-counts{display:flex;gap:1rem;margin-bottom:1rem}
.promo-count{background:var(--card);border-radius:8px;padding:.75rem 1.2rem;border:1px solid var(--border);text-align:center}
.promo-count .num{font-size:1.4rem;font-weight:700}
.promo-count .lbl{font-size:.7rem;color:var(--text2);text-transform:uppercase}
.bar{height:6px;border-radius:3px;background:var(--card2);overflow:hidden;margin-top:.3rem}
.bar-fill{height:100%;border-radius:3px;transition:width .3s}
.bar-fill.green{background:var(--green)}
.bar-fill.red{background:var(--red)}
.bar-fill.yellow{background:var(--yellow)}
@media(max-width:768px){
.stats-grid{grid-template-columns:repeat(3,1fr)}
.bet-card{grid-template-columns:auto 1fr;gap:.75rem;padding:.85rem}
.bet-right{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;text-align:left}
.filters{flex-direction:column}
.filters select,.filters input,.filters button{width:100%}
.promo-grid{grid-template-columns:1fr}
}
@media(max-width:480px){
.stats-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>PGR Sports Analytics</h1>
<p>AI-Powered Betting Predictions</p>
</header>

<div class="nav-tabs">
<div class="nav-tab active" data-page="bets" onclick="switchPage('bets')">Bets Feed</div>
<div class="nav-tab" data-page="leagues" onclick="switchPage('leagues')">League Rankings</div>
<div class="nav-tab" data-page="markets" onclick="switchPage('markets')">Market Rankings</div>
<div class="nav-tab" data-page="combos" onclick="switchPage('combos')">League+Market</div>
<div class="nav-tab" data-page="promotion" onclick="switchPage('promotion')">Auto Status</div>
<div class="nav-tab" data-page="history" onclick="switchPage('history')">History</div>
</div>

<div id="page-bets" class="page-section active">
<div class="stats-grid" id="statsGrid">
<div class="stat-card"><div class="value">-</div><div class="label">Total Bets</div></div>
<div class="stat-card green"><div class="value">-</div><div class="label">Won</div></div>
<div class="stat-card red"><div class="value">-</div><div class="label">Lost</div></div>
<div class="stat-card accent"><div class="value">-</div><div class="label">Hit Rate</div></div>
<div class="stat-card green"><div class="value">-</div><div class="label">Profit (u)</div></div>
<div class="stat-card"><div class="value">-</div><div class="label">ROI</div></div>
</div>

<div class="filters">
<select id="sportFilter">
<option value="">All Sports</option>
<option value="football">Football</option>
<option value="basketball">Basketball</option>
<option value="props">Player Props</option>
</select>
<select id="statusFilter">
<option value="">All Status</option>
<option value="upcoming">Upcoming</option>
<option value="won">Won</option>
<option value="lost">Lost</option>
<option value="settled">Settled</option>
</select>
<select id="sortFilter">
<option value="newest">Newest First</option>
<option value="kickoff">By Kickoff</option>
<option value="odds">Highest Odds</option>
<option value="ev">Best EV</option>
</select>
<input type="date" id="dateFrom" placeholder="From">
<input type="date" id="dateTo" placeholder="To">
<button onclick="applyFilters()">Filter</button>
<button class="secondary" onclick="resetFilters()">Reset</button>
</div>

<div class="tabs">
<div class="tab active" data-tab="all" onclick="switchTab('all')">All Bets</div>
<div class="tab" data-tab="football" onclick="switchTab('football')">Football</div>
<div class="tab" data-tab="basketball" onclick="switchTab('basketball')">Basketball</div>
<div class="tab" data-tab="props" onclick="switchTab('props')">Props</div>
</div>

<div id="betsContainer" class="bets-list">
<div class="loading"><div class="spinner"></div><p>Loading predictions...</p></div>
</div>

<div class="pagination" id="pagination" style="display:none">
<button id="prevBtn" onclick="prevPage()">Previous</button>
<span id="pageInfo">Page 1</span>
<button id="nextBtn" onclick="nextPage()">Next</button>
</div>
</div>

<div id="page-leagues" class="page-section">
<h2 class="section-title">League Rankings</h2>
<p class="section-subtitle">Performance of each league sorted by learning score</p>
<div class="window-select" id="leagueWindowSelect"></div>
<div class="table-container">
<table class="data-table" id="leagueTable">
<thead><tr><th>#</th><th>League</th><th>Bets</th><th>W/L</th><th>Hit Rate</th><th>ROI</th><th>CLV</th><th>Profit</th><th>Score</th></tr></thead>
<tbody id="leagueBody"><tr><td colspan="9" class="loading">Loading...</td></tr></tbody>
</table>
</div>
</div>

<div id="page-markets" class="page-section">
<h2 class="section-title">Market Rankings</h2>
<p class="section-subtitle">Performance of each market type sorted by learning score</p>
<div class="window-select" id="marketWindowSelect"></div>
<div class="table-container">
<table class="data-table" id="marketTable">
<thead><tr><th>#</th><th>Market</th><th>Bets</th><th>W/L</th><th>Hit Rate</th><th>ROI</th><th>CLV</th><th>Profit</th><th>Score</th></tr></thead>
<tbody id="marketBody"><tr><td colspan="9" class="loading">Loading...</td></tr></tbody>
</table>
</div>
</div>

<div id="page-combos" class="page-section">
<h2 class="section-title">League + Market Combinations</h2>
<p class="section-subtitle">Performance of each league-market combination (min 10 bets)</p>
<div class="window-select" id="comboWindowSelect"></div>
<div class="table-container">
<table class="data-table" id="comboTable">
<thead><tr><th>#</th><th>League</th><th>Market</th><th>Bets</th><th>Hit Rate</th><th>ROI</th><th>CLV</th><th>Profit</th><th>Score</th></tr></thead>
<tbody id="comboBody"><tr><td colspan="9" class="loading">Loading...</td></tr></tbody>
</table>
</div>
</div>

<div id="page-promotion" class="page-section">
<h2 class="section-title">Auto Promotion Status</h2>
<p class="section-subtitle">Markets automatically move between Production, Learning, and Disabled</p>
<div class="promo-counts" id="promoCounts"></div>
<div class="table-container">
<table class="data-table" id="promoTable">
<thead><tr><th>Status</th><th>League</th><th>Market</th><th>Bets</th><th>ROI</th><th>CLV</th><th>Profit</th><th>Reason</th></tr></thead>
<tbody id="promoBody"><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
</table>
</div>
</div>

<div id="page-history" class="page-section">
<h2 class="section-title">Performance History</h2>
<p class="section-subtitle">Breakdown per sport and market</p>
<div class="window-select" id="historyWindowSelect"></div>
<div id="historyCombined" class="stats-grid" style="margin-bottom:1.5rem"></div>
<div id="historySports"></div>
</div>

</div>

<script>
const API_BASE = window.location.origin + '/api';
let currentOffset = 0;
const PAGE_SIZE = 30;
let totalBets = 0;
let currentWindow = 'all_time';

function switchPage(page) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.nav-tab[data-page="${page}"]`).classList.add('active');
  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (page === 'leagues') loadLeagues();
  if (page === 'markets') loadMarkets();
  if (page === 'combos') loadCombos();
  if (page === 'promotion') loadPromotion();
  if (page === 'history') loadHistory();
}

function sportIcon(sport) {
  const icons = {football:'&#9917;', basketball:'&#127936;', props:'&#127919;'};
  return icons[sport] || '&#127942;';
}

function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  const now = new Date();
  const diff = d - now;
  if (Math.abs(diff) < 86400000) {
    return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }
  return d.toLocaleDateString([], {month:'short',day:'numeric'}) + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function colorVal(val, invert) {
  if (val > 0) return `<span style="color:var(--green)">${invert ? '' : '+'}${val.toFixed(1)}</span>`;
  if (val < 0) return `<span style="color:var(--red)">${val.toFixed(1)}</span>`;
  return `<span>${val.toFixed(1)}</span>`;
}

function renderWindowBtns(containerId, callback) {
  const wins = [['last_50','Last 50'],['last_100','Last 100'],['all_time','All Time']];
  const c = document.getElementById(containerId);
  c.innerHTML = wins.map(([k,l]) =>
    `<div class="window-btn ${currentWindow===k?'active':''}" onclick="currentWindow='${k}';renderWindowBtns('${containerId}',${callback.name});${callback.name}()">${l}</div>`
  ).join('');
}

function renderStats(s) {
  const profit = s.profit_units || 0;
  const roi = s.roi || 0;
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card"><div class="value">${s.settled || 0}</div><div class="label">Settled</div></div>
    <div class="stat-card green"><div class="value">${s.won || 0}</div><div class="label">Won</div></div>
    <div class="stat-card red"><div class="value">${s.lost || 0}</div><div class="label">Lost</div></div>
    <div class="stat-card accent"><div class="value">${s.hit_rate || 0}%</div><div class="label">Hit Rate</div></div>
    <div class="stat-card ${profit >= 0 ? 'green' : 'red'}"><div class="value">${profit >= 0 ? '+' : ''}${profit.toFixed(1)}u</div><div class="label">Profit</div></div>
    <div class="stat-card ${roi >= 0 ? 'green' : 'red'}"><div class="value">${roi >= 0 ? '+' : ''}${roi.toFixed(1)}%</div><div class="label">ROI</div></div>
  `;
}

function renderBets(bets) {
  const container = document.getElementById('betsContainer');
  if (!bets.length) {
    container.innerHTML = '<div class="empty">No bets found with current filters.</div>';
    return;
  }
  container.innerHTML = bets.map(b => {
    const profitVal = b.profit_units;
    let profitHtml = '';
    if (b.status === 'won' || b.status === 'lost') {
      const cls = profitVal >= 0 ? 'win' : 'loss';
      profitHtml = `<div class="profit ${cls}">${profitVal >= 0 ? '+' : ''}${(profitVal||0).toFixed(2)}u</div>`;
    }
    const evClass = (b.ev_pct && b.ev_pct > 0) ? 'positive' : '';
    const evText = b.ev_pct != null ? `EV: ${b.ev_pct >= 0 ? '+' : ''}${b.ev_pct.toFixed(1)}%` : '';
    const trustBadge = b.trust_level ? ` | ${b.trust_level}` : '';
    const statusClass = b.status === 'won' ? 'status-won' : b.status === 'lost' ? 'status-lost' : b.status === 'live' ? 'status-live' : b.status === 'void' || b.status === 'voided' ? 'status-void' : 'status-upcoming';
    const statusLabel = b.status === 'pending' ? 'upcoming' : b.status;
    return `
    <div class="bet-card ${statusClass}">
      <div class="bet-sport">${sportIcon(b.sport)}</div>
      <div class="bet-info">
        <h3>${b.match}</h3>
        <div class="market">${b.market}: ${b.selection}</div>
        <div class="meta">${b.league || ''} | ${formatDate(b.kickoff)}${trustBadge}</div>
      </div>
      <div class="bet-right">
        <div>
          <div class="odds">${b.odds.toFixed(2)}x</div>
          <div class="ev ${evClass}">${evText}</div>
          <span class="status-badge ${statusLabel}">${statusLabel}</span>
          ${profitHtml}
        </div>
      </div>
    </div>`;
  }).join('');
}

function updatePagination() {
  const pg = document.getElementById('pagination');
  const pages = Math.ceil(totalBets / PAGE_SIZE);
  const current = Math.floor(currentOffset / PAGE_SIZE) + 1;
  if (pages <= 1) { pg.style.display = 'none'; return; }
  pg.style.display = 'flex';
  document.getElementById('pageInfo').textContent = `Page ${current} of ${pages}`;
  document.getElementById('prevBtn').disabled = currentOffset === 0;
  document.getElementById('nextBtn').disabled = currentOffset + PAGE_SIZE >= totalBets;
}

function getFilterParams() {
  const sport = document.getElementById('sportFilter').value;
  const status = document.getElementById('statusFilter').value;
  const sort = document.getElementById('sortFilter').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  const p = new URLSearchParams();
  if (sport) p.set('sport', sport);
  if (status) p.set('status', status);
  p.set('sort', sort);
  if (dateFrom) p.set('date_from', dateFrom);
  if (dateTo) p.set('date_to', dateTo);
  p.set('limit', PAGE_SIZE);
  p.set('offset', currentOffset);
  return p.toString();
}

async function loadBets() {
  const container = document.getElementById('betsContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
  try {
    const res = await fetch(`${API_BASE}/bets?${getFilterParams()}`);
    const data = await res.json();
    totalBets = data.total;
    renderBets(data.bets);
    updatePagination();
  } catch(e) {
    container.innerHTML = `<div class="empty">Failed to load bets. ${e.message}</div>`;
  }
}

async function loadStats() {
  try {
    const res = await fetch(`${API_BASE}/bets/stats`);
    const data = await res.json();
    renderStats(data);
  } catch(e) { console.error('Stats error:', e); }
}

function applyFilters() { currentOffset = 0; loadBets(); }
function resetFilters() {
  document.getElementById('sportFilter').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('sortFilter').value = 'newest';
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  currentOffset = 0;
  loadBets();
}
function prevPage() { currentOffset = Math.max(0, currentOffset - PAGE_SIZE); loadBets(); }
function nextPage() { currentOffset += PAGE_SIZE; loadBets(); }

function switchTab(sport) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${sport}"]`).classList.add('active');
  document.getElementById('sportFilter').value = sport === 'all' ? '' : sport;
  currentOffset = 0;
  loadBets();
}

async function loadLeagues() {
  renderWindowBtns('leagueWindowSelect', loadLeagues);
  const body = document.getElementById('leagueBody');
  body.innerHTML = '<tr><td colspan="9" class="loading">Loading...</td></tr>';
  try {
    const res = await fetch(`${API_BASE}/learning/league_rankings?window=${currentWindow}`);
    const data = await res.json();
    if (!data.length) { body.innerHTML = '<tr><td colspan="9" class="empty">No data yet</td></tr>'; return; }
    body.innerHTML = data.map((r, i) => `
      <tr>
        <td>${i+1}</td>
        <td><strong>${r.label || r.league}</strong></td>
        <td>${r.total_bets}</td>
        <td>${r.wins}/${r.losses}</td>
        <td>${r.hit_rate.toFixed(1)}%</td>
        <td>${colorVal(r.roi_pct)}</td>
        <td>${r.avg_clv.toFixed(3)}</td>
        <td>${colorVal(r.profit_units)}</td>
        <td><strong>${r.score.toFixed(1)}</strong></td>
      </tr>
    `).join('');
  } catch(e) { body.innerHTML = `<tr><td colspan="9">${e.message}</td></tr>`; }
}

async function loadMarkets() {
  renderWindowBtns('marketWindowSelect', loadMarkets);
  const body = document.getElementById('marketBody');
  body.innerHTML = '<tr><td colspan="9" class="loading">Loading...</td></tr>';
  try {
    const res = await fetch(`${API_BASE}/learning/market_rankings?window=${currentWindow}`);
    const data = await res.json();
    if (!data.length) { body.innerHTML = '<tr><td colspan="9" class="empty">No data yet</td></tr>'; return; }
    body.innerHTML = data.map((r, i) => `
      <tr>
        <td>${i+1}</td>
        <td><strong>${r.label || r.market}</strong></td>
        <td>${r.total_bets}</td>
        <td>${r.wins}/${r.losses}</td>
        <td>${r.hit_rate.toFixed(1)}%</td>
        <td>${colorVal(r.roi_pct)}</td>
        <td>${r.avg_clv.toFixed(3)}</td>
        <td>${colorVal(r.profit_units)}</td>
        <td><strong>${r.score.toFixed(1)}</strong></td>
      </tr>
    `).join('');
  } catch(e) { body.innerHTML = `<tr><td colspan="9">${e.message}</td></tr>`; }
}

async function loadCombos() {
  renderWindowBtns('comboWindowSelect', loadCombos);
  const body = document.getElementById('comboBody');
  body.innerHTML = '<tr><td colspan="9" class="loading">Loading...</td></tr>';
  try {
    const res = await fetch(`${API_BASE}/learning/league_market?window=${currentWindow}&min_bets=10`);
    const data = await res.json();
    if (!data.length) { body.innerHTML = '<tr><td colspan="9" class="empty">No data yet (min 10 bets)</td></tr>'; return; }
    body.innerHTML = data.map((r, i) => `
      <tr>
        <td>${i+1}</td>
        <td>${r.league}</td>
        <td><strong>${r.market}</strong></td>
        <td>${r.total_bets}</td>
        <td>${r.hit_rate.toFixed(1)}%</td>
        <td>${colorVal(r.roi_pct)}</td>
        <td>${r.avg_clv.toFixed(3)}</td>
        <td>${colorVal(r.profit_units)}</td>
        <td><strong>${r.score.toFixed(1)}</strong></td>
      </tr>
    `).join('');
  } catch(e) { body.innerHTML = `<tr><td colspan="9">${e.message}</td></tr>`; }
}

async function loadPromotion() {
  const body = document.getElementById('promoBody');
  body.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';
  try {
    const res = await fetch(`${API_BASE}/learning/promotion_status`);
    const data = await res.json();
    const counts = {PRODUCTION:0, LEARNING_ONLY:0, DISABLED:0};
    data.forEach(r => { if (counts[r.status] !== undefined) counts[r.status]++; });
    document.getElementById('promoCounts').innerHTML = `
      <div class="promo-count"><div class="num" style="color:var(--green)">${counts.PRODUCTION}</div><div class="lbl">Production</div></div>
      <div class="promo-count"><div class="num" style="color:var(--yellow)">${counts.LEARNING_ONLY}</div><div class="lbl">Learning</div></div>
      <div class="promo-count"><div class="num" style="color:var(--red)">${counts.DISABLED}</div><div class="lbl">Disabled</div></div>
    `;
    if (!data.length) { body.innerHTML = '<tr><td colspan="8" class="empty">No data yet</td></tr>'; return; }
    body.innerHTML = data.map(r => {
      const roiColor = r.roi_pct > 0 ? 'var(--green)' : r.roi_pct < 0 ? 'var(--red)' : 'var(--text)';
      return `
      <tr>
        <td><span class="status-badge ${r.status}">${r.status.replace('_',' ')}</span></td>
        <td>${r.league_name || r.league}</td>
        <td>${r.market}</td>
        <td>${r.total_bets}</td>
        <td style="color:${roiColor}">${r.roi_pct.toFixed(1)}%</td>
        <td>${r.avg_clv.toFixed(3)}</td>
        <td>${colorVal(r.profit_units)}</td>
        <td style="font-size:.75rem;color:var(--text2)">${r.reason || '-'}</td>
      </tr>`;
    }).join('');
  } catch(e) { body.innerHTML = `<tr><td colspan="8">${e.message}</td></tr>`; }
}

let historyPeriod = 'all';

function renderHistoryWindowBtns() {
  const wins = [['7d','Last 7 Days'],['30d','Last 30 Days'],['90d','Last 90 Days'],['all','All Time']];
  const c = document.getElementById('historyWindowSelect');
  c.innerHTML = wins.map(([k,l]) =>
    `<div class="window-btn ${historyPeriod===k?'active':''}" onclick="historyPeriod='${k}';loadHistory()">${l}</div>`
  ).join('');
}

async function loadHistory() {
  renderHistoryWindowBtns();
  const combined = document.getElementById('historyCombined');
  const sportsDiv = document.getElementById('historySports');
  combined.innerHTML = '<div class="stat-card"><div class="value"><div class="spinner"></div></div><div class="label">Loading...</div></div>';
  sportsDiv.innerHTML = '';

  try {
    const res = await fetch(`${API_BASE}/bets/history?period=${historyPeriod}`);
    const data = await res.json();
    const c = data.combined;

    combined.innerHTML = `
      <div class="stat-card"><div class="value">${c.settled}</div><div class="label">Total Settled</div></div>
      <div class="stat-card green"><div class="value">${c.won}</div><div class="label">Won</div></div>
      <div class="stat-card red"><div class="value">${c.lost}</div><div class="label">Lost</div></div>
      <div class="stat-card accent"><div class="value">${c.hit_rate}%</div><div class="label">Hit Rate</div></div>
      <div class="stat-card ${c.profit_units >= 0 ? 'green' : 'red'}"><div class="value">${c.profit_units >= 0 ? '+' : ''}${c.profit_units.toFixed(1)}u</div><div class="label">Profit</div></div>
      <div class="stat-card ${c.roi >= 0 ? 'green' : 'red'}"><div class="value">${c.roi >= 0 ? '+' : ''}${c.roi.toFixed(1)}%</div><div class="label">ROI</div></div>
    `;

    sportsDiv.innerHTML = data.sports.map(s => {
      const profitColor = s.profit_units >= 0 ? 'var(--green)' : 'var(--red)';
      const roiColor = s.roi >= 0 ? 'var(--green)' : 'var(--red)';
      const winPct = s.settled > 0 ? (s.won / s.settled * 100) : 0;

      let marketsHtml = '';
      if (s.markets && s.markets.length > 0) {
        marketsHtml = `
          <div class="table-container" style="margin-top:.75rem;max-height:300px">
            <table class="data-table">
              <thead><tr><th>Market</th><th>Bets</th><th>W/L</th><th>Hit Rate</th><th>Profit</th><th>ROI</th></tr></thead>
              <tbody>
                ${s.markets.map(m => {
                  const mProfitColor = m.profit >= 0 ? 'var(--green)' : 'var(--red)';
                  const mRoiColor = m.roi >= 0 ? 'var(--green)' : 'var(--red)';
                  return `<tr>
                    <td><strong>${m.name}</strong></td>
                    <td>${m.total}</td>
                    <td>${m.won}/${m.lost}</td>
                    <td>${m.hit_rate}%</td>
                    <td style="color:${mProfitColor};font-weight:700">${m.profit >= 0 ? '+' : ''}${m.profit.toFixed(1)}u</td>
                    <td style="color:${mRoiColor};font-weight:700">${m.roi >= 0 ? '+' : ''}${m.roi.toFixed(1)}%</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>`;
      }

      return `
        <div style="background:var(--card);border-radius:10px;padding:1.25rem;border:1px solid var(--border);margin-bottom:1rem">
          <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
            <span style="font-size:1.5rem">${s.icon}</span>
            <div>
              <h3 style="font-size:1.1rem;font-weight:700;margin:0">${s.label}</h3>
              <span style="color:var(--text2);font-size:.8rem">${s.total} total bets | ${s.settled} settled | ${s.upcoming} upcoming</span>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem;margin-bottom:.75rem">
            <div style="text-align:center;padding:.5rem;background:var(--card2);border-radius:8px">
              <div style="font-size:1.3rem;font-weight:700;color:var(--green)">${s.won}</div>
              <div style="font-size:.7rem;color:var(--text2)">WON</div>
            </div>
            <div style="text-align:center;padding:.5rem;background:var(--card2);border-radius:8px">
              <div style="font-size:1.3rem;font-weight:700;color:var(--red)">${s.lost}</div>
              <div style="font-size:.7rem;color:var(--text2)">LOST</div>
            </div>
            <div style="text-align:center;padding:.5rem;background:var(--card2);border-radius:8px">
              <div style="font-size:1.3rem;font-weight:700;color:var(--accent)">${s.hit_rate}%</div>
              <div style="font-size:.7rem;color:var(--text2)">HIT RATE</div>
            </div>
            <div style="text-align:center;padding:.5rem;background:var(--card2);border-radius:8px">
              <div style="font-size:1.3rem;font-weight:700;color:${profitColor}">${s.profit_units >= 0 ? '+' : ''}${s.profit_units.toFixed(1)}u</div>
              <div style="font-size:.7rem;color:var(--text2)">PROFIT</div>
            </div>
            <div style="text-align:center;padding:.5rem;background:var(--card2);border-radius:8px">
              <div style="font-size:1.3rem;font-weight:700;color:${roiColor}">${s.roi >= 0 ? '+' : ''}${s.roi.toFixed(1)}%</div>
              <div style="font-size:.7rem;color:var(--text2)">ROI</div>
            </div>
          </div>
          <div class="bar" style="height:8px;margin-bottom:.5rem">
            <div class="bar-fill green" style="width:${winPct.toFixed(1)}%"></div>
          </div>
          <div style="font-size:.75rem;color:var(--text2);text-align:right">${winPct.toFixed(1)}% win rate</div>
          ${marketsHtml}
        </div>
      `;
    }).join('');

  } catch(e) {
    combined.innerHTML = `<div class="empty">Failed to load history. ${e.message}</div>`;
  }
}

loadStats();
loadBets();
setInterval(() => { loadStats(); loadBets(); }, 120000);
</script>
</body>
</html>
